generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  id        Int       @id @default(autoincrement())
  username  String    @unique @db.VarChar(50)
  password  String    @db.VarChar(100)
  role      String    @db.VarChar(20) @default("branch")
  branchId  Int?
  name      String    @db.VarChar(100)
  email     String    @unique @db.VarChar(100)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt DateTime  @updatedAt @db.Timestamptz(6)
  branch    branches? @relation(fields: [branchId], references: [id])

  @@index([branchId], map: "idx_users_branch")
}

model model_loan_templates {
  id                     Int      @id @default(autoincrement())
  item_id                Int
  term_months            Int
  loan_amount            Decimal  @db.Decimal(12, 2)
  downpayment_percentage Decimal  @db.Decimal(5, 2)
  rebates_commission     Decimal  @db.Decimal(12, 2)
  monthly_amortization   Decimal  @db.Decimal(12, 2)
  created_at             DateTime @default(now()) @db.Timestamptz(6)
  items                  items    @relation(fields: [item_id], references: [id], onDelete: Cascade)

  @@unique([item_id, term_months])
}

model branches {
  id                  Int                   @id @default(autoincrement())
  name                String                @db.VarChar(100)
  address             String?
  created_at          DateTime?             @default(now()) @db.Timestamptz(6)
  inventory_movements inventory_movements[]
  purchase_orders     purchase_orders[]
  sales               sales[]
  users               users[]
}

model inventory_movements {
  id              Int               @id @default(autoincrement())
  branch_id       Int
  item_id         Int
  date_received   DateTime          @db.Date
  supplier_id     Int?
  dr_no           String?           @db.VarChar(50)
  si_no           String?           @db.VarChar(50)
  cost            Decimal           @db.Decimal(12, 2)
  beginning_qty   Int?              @default(0)
  purchased_qty   Int?              @default(0)
  transferred_qty Int?              @default(0)
  sold_qty        Int?              @default(0)
  ending_qty      Int?
  remarks         String?
  created_at      DateTime?         @default(now()) @db.Timestamptz(6)
  srp             Decimal?          @db.Decimal(12, 2)
  margin          Decimal?          @default(dbgenerated("\nCASE\n    WHEN ((srp IS NOT NULL) AND (cost > (0)::numeric)) THEN (((srp - cost) / cost) * (100)::numeric)\n    ELSE (0)::numeric\nEND")) @db.Decimal(12, 2)
  color           String?           @db.VarChar(50)
  status          String?           @default("available") @db.VarChar(20)
  branches        branches          @relation(fields: [branch_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  items           items             @relation(fields: [item_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  suppliers       suppliers?        @relation(fields: [supplier_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  sales_inventory sales_inventory[]
  vehicle_units   vehicle_units[]

  @@index([item_id], map: "idx_inv_movements_item")
}

model items {
  id                   Int                    @id @default(autoincrement())
  item_no              String                 @unique @db.VarChar(50)
  brand                String?                @db.VarChar(100)
  model                String?                @db.VarChar(100)
  color                String[]               @default([]) @db.VarChar(50)
  cost_of_purchase     Decimal?               @db.Decimal(12, 2)
  engine_no            String?                @db.VarChar(100)
  chassis_no           String?                @db.VarChar(100)
  created_at           DateTime?              @default(now()) @db.Timestamptz(6)
  srp                  Decimal?               @db.Decimal(12, 2)
  inventory_movements  inventory_movements[]
  model_loan_templates model_loan_templates[]
  purchase_order_items purchase_order_items[]
  sales_items          sales_items[]
}

model payment_schedules {
  id             Int       @id @default(autoincrement())
  reference_type String    @db.VarChar(20)
  reference_id   Int
  due_date       DateTime  @db.Date
  amount_due     Decimal   @db.Decimal(14, 2)
  paid_amount    Decimal?  @default(0) @db.Decimal(14, 2)
  paid_date      DateTime? @db.Date
  status         String?   @default("PENDING") @db.VarChar(20)
  remarks        String?
}

model loan_payments {
  id          Int       @id @default(autoincrement())
  sale_id     Int
  payment_no  Int
  due_date    DateTime  @db.Date
  amount      Decimal   @db.Decimal(14, 2)
  paid_date   DateTime? @db.Date
  paid_amount Decimal?  @default(0) @db.Decimal(14, 2)
  status      String    @default("pending") @db.VarChar(20)
  remarks     String?
  created_at  DateTime  @default(now()) @db.Timestamptz(6)
  sales       sales     @relation(fields: [sale_id], references: [id], onDelete: Cascade)

  @@index([sale_id], map: "idx_loan_payments_sale")
  @@index([due_date], map: "idx_loan_payments_due_date")
}

model purchase_order_items {
  id                Int             @id @default(autoincrement())
  purchase_order_id Int
  item_id           Int
  model_code        String?         @db.VarChar(50)
  color             String?         @db.VarChar(50)
  quantity          Int
  unit_price        Decimal         @db.Decimal(12, 2)
  amount            Decimal?        @db.Decimal(14, 2)
  delivery_status   String?         @default("pending") @db.VarChar(20)
  rebate_percentage Decimal?        @db.Decimal(12, 2)
  delivered_qty     Int             @default(0)
  items             items           @relation(fields: [item_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  purchase_orders   purchase_orders @relation(fields: [purchase_order_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model purchase_orders {
  id                   Int                    @id @default(autoincrement())
  po_number            String                 @unique @db.VarChar(50)
  branch_id            Int?
  supplier_id          Int?
  date_issued          DateTime               @db.Date
  due_date             DateTime?              @db.Date
  contact_person       String?                @db.VarChar(100)
  contact_number       String?                @db.VarChar(50)
  payment_term         String?                @db.VarChar(100)
  payment_mode         String?                @db.VarChar(50)
  prompt_rebate_pct    Decimal?               @db.Decimal(5, 2)
  prepared_by          String?                @db.VarChar(100)
  checked_by           String?                @db.VarChar(100)
  created_at           DateTime?              @default(now()) @db.Timestamptz(6)
  dealer_discount      Decimal?               @db.Decimal(12, 2)
  payment_status       String?                @default("unpaid") @db.VarChar(20)
  check_number         String?                @db.VarChar(50)
  check_date           DateTime?              @db.Date
  purchase_order_items purchase_order_items[]
  branches             branches?              @relation(fields: [branch_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  suppliers            suppliers?             @relation(fields: [supplier_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([due_date], map: "idx_po_due_date")
}

model sales {
  id                     Int               @id @default(autoincrement())
  branch_id              Int?
  date_sold              DateTime          @db.Date
  dr_no                  String?           @db.VarChar(50)
  si_no                  String?           @db.VarChar(50)
  total_amount           Decimal           @db.Decimal(14, 2)
  payment_method         String?           @db.VarChar(50)
  category_of_sales      String?           @db.VarChar(50)
  source_of_sales        String?           @db.VarChar(20)
  last_name              String            @default("") @db.VarChar(100)
  first_name             String            @default("") @db.VarChar(100)
  middle_name            String?           @db.VarChar(100)
  address                String?
  contact_no             String?           @db.VarChar(50)
  loan_amount            Decimal?          @db.Decimal(14, 2)
  date_granted           DateTime?         @db.Date
  maturity_date          DateTime?         @db.Date
  terms                  Int?
  downpayment_percentage Decimal?          @db.Decimal(5, 2)
  rebates_commission     Decimal?          @db.Decimal(14, 2)
  monthly_amortization   Decimal?          @db.Decimal(14, 2)
  ar_balance             Decimal?          @db.Decimal(14, 2)
  age                    Int?
  agent                  String?           @db.VarChar(100)
  fmo                    String?           @db.VarChar(100)
  bm                     String?           @db.VarChar(100)
  mechanic               String?           @db.VarChar(100)
  bao                    String?           @db.VarChar(100)
  payment_status         String?           @default("ongoing") @db.VarChar(20)
  delivery_status        String?           @default("pending") @db.VarChar(20)
  delivery_date          DateTime?         @db.Date
  branches               branches?         @relation(fields: [branch_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  loan_payments          loan_payments[]
  sales_inventory        sales_inventory[]
  sales_items            sales_items[]
  lto_registrations      lto_registrations[]

  @@index([date_sold], map: "idx_sales_date")
}

model sales_items {
  id              Int            @id @default(autoincrement())
  sale_id         Int
  item_id         Int
  qty             Int
  unit_price      Decimal        @db.Decimal(12, 2)
  amount          Decimal?       @db.Decimal(14, 2)
  vehicle_unit_id Int?
  vehicle_unit    vehicle_units? @relation(fields: [vehicle_unit_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_sales_items_vehicle_unit")
  items           items          @relation(fields: [item_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  sales           sales          @relation(fields: [sale_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model suppliers {
  id                  Int                   @id @default(autoincrement())
  name                String                @db.VarChar(150)
  tin_number          String?               @db.VarChar(50)
  contact_person      String?               @db.VarChar(100)
  contact_number      String?               @db.VarChar(50)
  address             String?
  created_at          DateTime?             @default(now()) @db.Timestamptz(6)
  inventory_movements inventory_movements[]
  purchase_orders     purchase_orders[]
}

model vehicle_units {
  id           Int                 @id @default(autoincrement())
  inventory_id Int
  chassis_no   String?             @db.VarChar(100)
  engine_no    String?             @db.VarChar(100)
  unit_number  Int
  transferred   Boolean             @default(false)
  created_at   DateTime?           @default(now()) @db.Timestamptz(6)
  status       String?             @default("available") @db.VarChar(20)
  sales_items  sales_items[]
  lto_registrations lto_registrations[]
  inventory    inventory_movements @relation(fields: [inventory_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([inventory_id, unit_number])
  @@index([inventory_id], map: "idx_vehicle_units_inventory")
}

model sales_inventory {
  id           Int                 @id @default(autoincrement())
  sale_id      Int
  inventory_id Int
  qty          Int                 @default(1)
  inventory    inventory_movements @relation(fields: [inventory_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  sales        sales               @relation(fields: [sale_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model lto_registrations {
  id                    Int           @id @default(autoincrement())
  sale_id              Int?
  vehicle_unit_id      Int?
  plate_number         String?       @unique @db.VarChar(20)
  engine_number        String        @db.VarChar(50)
  chassis_number       String        @db.VarChar(50)
  mv_file_number       String?       @unique @db.VarChar(50)
  cr_number            String?       @db.VarChar(50)
  or_number            String?       @db.VarChar(50)
  registration_date    DateTime?     @db.Date
  expiration_date      DateTime?     @db.Date
  insurance_provider   String?       @db.VarChar(100)
  insurance_policy_number String?    @db.VarChar(50)
  insurance_expiry     DateTime?     @db.Date
  // New number fields replacing status fields
  csr_number          String?       @db.VarChar(50)
  sdr_number          String?       @db.VarChar(50)
  insurance_number    String?       @db.VarChar(50)
  registration_fee     Decimal?      @db.Decimal(10,2)
  insurance_fee        Decimal?      @db.Decimal(10,2)
  status              String        @default("pending") @db.VarChar(20)
  created_at          DateTime      @default(now())
  updated_at          DateTime      @updatedAt
  remarks             String?       @db.Text
  
  // Relations
  sale                 sales?        @relation(fields: [sale_id], references: [id])
  vehicle_unit         vehicle_units? @relation(fields: [vehicle_unit_id], references: [id])

  @@index([sale_id], name: "idx_lto_reg_sale")
  @@index([status], name: "idx_lto_reg_status")
}

// History table for transferred units. Mirrors key fields from
// inventory_movements and vehicle_units so we keep them out of active inventory.
model transferred_history {
  id                       Int       @id @default(autoincrement())
  branch_id                Int
  item_id                  Int
  date_received            DateTime  @db.Date
  supplier_id              Int?
  dr_no                    String?   @db.VarChar(50)
  si_no                    String?   @db.VarChar(50)
  cost                     Decimal   @default(0) @db.Decimal(12, 2)
  beginning_qty            Int?      @default(0)
  purchased_qty            Int?      @default(0)
  transferred_qty          Int?      @default(1)
  sold_qty                 Int?      @default(0)
  ending_qty               Int?
  remarks                  String?
  created_at               DateTime? @default(now()) @db.Timestamptz(6)
  srp                      Decimal?  @db.Decimal(12, 2)
  margin                   Decimal?  @default(0) @db.Decimal(12, 2)
  color                    String?   @db.VarChar(50)
  status                   String?   @default("transferred") @db.VarChar(20)
  chassis_no               String?   @db.VarChar(100)
  engine_no                String?   @db.VarChar(100)
  unit_number              Int?      @default(1)
  unit_created_at          DateTime? @default(now()) @db.Timestamptz(6)
  unit_status              String?   @default("transferred") @db.VarChar(20)
  original_inventory_id    Int?
  original_vehicle_unit_id Int?

  @@index([engine_no])
  @@index([chassis_no])
  @@index([branch_id])
  @@index([item_id])
}
